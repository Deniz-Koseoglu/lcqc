### Интегрирование

Этот модуль предназначен для расчёта базовых линий отдельных пиков и интегрирования их площадей 
с использованием правила трапеций. Рабочий процесс оценивает пики на основе их разрешения. 
Сначала базовые линии для полностью разрешённых пиков рассчитываются с помощью алгоритма FastChrom 
(см. Johnsen *et al.*, [2013](https://doi.org/10.1039/c3an36276k)). Общие базовые линии для групп 
неразрешённых пиков также определяются таким же образом.

Вкладка **Основные** представляет несколько методов интегрирования, большинство из которых были описаны 
Waters Corporation ([2017](https://www.waters.com/content/dam/waters/en/library/white-papers/2007/720000494en.pdf)).
Границы между каждой парой неразрешённых пиков могут быть разделены простой базовой линией **перпендикулярного 
опускания**. Перпендикулярное опускание имеет тенденцию всё больше искажать площади пиков с уменьшением разрешения.
В качестве альтернативы границы пиков проверяются на пригодность для одного из трёх подходов «скользящей» 
базовой линии: **касательное скольжение**, **экспоненциальное скольжение** или **гауссово скольжение**. 
Это делается путём оценки ряда условий:

1. Классифицируется ли граница пика как слитая или плечевая?
2. Классифицируется ли хотя бы один пик в оцениваемой паре как слитый или плечевой?

Если любое из этих начальных условий ложно, **скольжение не применяется**. В противном случае оцениваются 
дополнительные условия:

3. Является ли раньше элюирующийся пик родительским или дочерним пиком (определяется на основе высоты 
максимумов пиков)? Это определяет, применять ли **фронтальное** или **хвостовое** скольжение.

4. Находится ли вершина дочернего пика ниже ближайшей (по оси x) точки перегиба родительского пика? 
Если это условие ложно, **экспоненциальное или гауссово** скольжение не применяется.

5. Является ли *отношение скольжение-впадина* (**высота дочернего пика к высоте межпиковой границы/впадины**) 
ниже порога, установленного в skim?

6. Является ли отношение высоты родительского пика к дочернему выше *критерия Дайсона*? 
Если любое из зависимых условий ложно, **скольжение не выполняется**.

7. Выше ли внешняя граница дочернего пика, чем межпиковая граница? 
Если да, касательное скольжение невозможно.

Эти условия также определяют идентичность родительского и дочернего пика, а также соответствующий тип 
скольжения (фронтальное или хвостовое) для каждой пары пиков. Таким образом, если граница определена 
как подходящая на основе вышеуказанных условий, предпринимается попытка построения и оптимизации 
скользящей базовой линии указанного типа.

Для фронтального касательного скольжения от родительского пика проводятся прямые линии от межпиковой границы 
к каждой точке между началом и максимумом дочернего пика (который в данном случае элюируется раньше). 
Для хвостового касательного скольжения линии проводятся между межпиковой границей и каждой точкой между 
максимумом и концом дочернего пика (который теперь является позже элюирующимся пиком). 
Линии, y-значения которых превышают **>2%** от максимального сигнала дочернего пика в любой точке, отбрасываются. 
Среди остальных выбирается линия, конечная точка которой ближе всего к внешней границе дочернего пика 
и где **<40%** значений находятся в пределах **1%** от соответствующего значения хроматографического сигнала.

Для **экспоненциального скольжения** используется следующее уравнение для построения экспоненциальной кривой, 
простирающейся от точки перегиба родительского пика, ближайшей к межпиковой границе, к началу 
(для фронтального скольжения) или концу (для хвостового скольжения) дочернего пика.

$$ H_{ex} = H_0\times exp^{(-B\times(t_R-t_0))} + A\times t_R + C $$

Где $H_{ex}$ — значение экспоненциальной кривой, $H_0$ — высота (сигнал) на межпиковой границе (например, впадине),
$B$ — функция экспоненциального роста/убывания (отрицательная для **хвостового** скольжения), $A$ — наклон базовой 
линии родительского пика, $C$ — смещение базовой линии родительского пика, а $t_R$ и $t_0$ — времена удерживания 
при $H_b$ и межпиковой границе соответственно. Начальная экспоненциальная кривая строится со значениями 
$B$ и $C$, равными **0**. Затем константа смещения $C$ определяется разницей между результатом и сигналом 
на межпиковой границе, а константа $B$ экспоненциальной аппроксимации оптимизируется для минимального 
**евклидова расстояния** между кривой и исходным хроматографическим сигналом **в области родительского пика** 
(от ближайшей точки перегиба до межпиковой границы). Наконец, экспоненциальная кривая от межпиковой границы 
до внешней границы дочернего пика строится с использованием оптимизированных констант $B$ и $C$. 
Она используется как скользящая базовая линия.

Для **гауссова скольжения** используется следующая общая форма гауссовой кривой для построения модели 
между вершиной родительского пика и межпиковой границей.

$$ H_{gs} = H_p\times exp^{-(\frac{t_R-t_0}{\sigma})^2} $$

Где $H_{gs}$ — значение гауссовой кривой, $H_p$ — максимальный сигнал родительского пика, $t_0$ — 
соответствующее время удерживания, $t_R$ — время удерживания при $H_{gs}$, а $\sigma$ — стандартное 
отклонение гауссовой кривой (здесь оценивается как полуширина пика в точках перегиба). 
Гауссова кривая итеративно оптимизируется до минимизации **евклидова расстояния** между результирующей 
кривой и исходным родительским пиком. Затем строится окончательная кривая с использованием оптимизированных 
параметров между вершиной **родительского** пика и внешней границей **дочернего** пика. 
Затем модель проверяется на два условия:

1. Выше ли нижняя точка гауссовой кривой **1%** от максимума родительского пика?
2. Находятся ли какие-либо точки кривой в области **дочернего** пика выше исходного сигнала 
(т.е. пересекает ли кривая хроматограмму)?

Если любое из вышеперечисленного верно, гауссова кривая отклоняется, дальнейшее скольжение не предпринимается, 
и вместо этого строится перпендикулярная опускная линия. В противном случае гауссова кривая усекается 
от максимума **родительского** пика до точки, где кривая имеет стабильно более низкий сигнал (т.е. высоту), 
чем исходная хроматограмма.

После построения всех базовых линий используется **правило трапеций** для интегрирования всех пиков 
и расчёта их площадей ($PA$).

$$ PA = \sum{(x_{i+1}-x_i)\times(y_{i+1}+y_i)/2} $$

**Таблица результатов** классифицирует тип интегрирования для каждого пика как **PD** (перпендикулярное опускание),
**TS** (касательное скольжение), **ES** (экспоненциальное скольжение) или **GS** (гауссово скольжение).
